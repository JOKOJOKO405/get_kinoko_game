<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style type="text/css">
      .kinoko-count{
        font-size: 20px;
        font-weight: bold;
        color: orange;
      }
    </style>
  </head>
  <body style="padding: 100px">
    <canvas
      id="canvas"
      style="background-color: teal"
      width="500"
      height="500"
    ></canvas>
    <p>取れたきのこの数<span id="js-kinoko" class="kinoko-count"></span>個</p>
    <script>
      // きのこインスタンス格納用配列
      let kinokoGroup = []
      // 取れたきのこの数
      let kinokoCount = 0
      const kinokoDOM = document.getElementById("js-kinoko")
      kinokoDOM.innerText = kinokoCount

      // キャンバス
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const imageBoy = new Image();
      const imageItem = new Image();
      imageBoy.src = "./img/ico_boy1_1.gif";
      imageItem.src = './img/ico_mushroom2_23.gif'

      // TODO ここクラス作れるのでは？
      let charaX = 0;
      let charaY = 0;
      let charaW = 18;
      let charaH = 34;
      let charaCentX;
      let charaCentY;

      // きのこクラス
      class Kinoko{
        constructor(x, y, width = 20, height = 20, centerX, centerY) {
          this.x = x;
          this.y = y;
          this.width = width;
          this.height = height;
          this.centerX = this.x + this.width / 2;
          this.centerY = this.y + this.height / 2;
          this.isTouchedKinoko = false
          kinokoGroup.push(this)
        }
        draw() {
          if(!this.isTouchedKinoko){
            ctx.drawImage(imageItem, this.x, this.y, this.width, this.height)
          }
        }
        // きのこグループの座標を取得してキャラとぶつかったかの判定を行う
        getKinoko(){
          if((charaCentX >= this.centerX && charaCentX <= this.x + this.width) && (charaCentY >= this.centerY && charaCentY <= this.y + this.height)){ 
            this.isTouchedKinoko = true
            kinokoCount++
            kinokoDOM.innerText = kinokoCount
            // alert('kinoko get!')
            delete this;
          }
        }
      }

      // キノコのインスタンス化複数
      const kinokoNum = 30;
      const makeKinokos = () => {
        let kinokos = {}
        let max = 480
        let min = 30
        
        for (let i = 0; i < kinokoNum; i++) {
          const randomNumX = Math.floor(Math.random() * (max - min + 1) + min);
          const randomNumY = Math.floor(Math.random() * (max - min + 1) + min);
          kinokos[i] = new Kinoko(randomNumX, randomNumY)
        }
        return kinokos
      }
      makeKinokos()

      // キャラクターの動き
      const charaMove = () => {
        ctx.clearRect(0, 0, 500, 500);
        ctx.drawImage(imageBoy, charaX, charaY, 18, 34);
        kinokoGroup.forEach(kinoko => {
          kinoko.draw()
          kinoko.getKinoko()
        })
        charaCentX = charaX + charaW / 2;
        charaCentY = charaY + charaH / 2;
      }

      // 画像描画
      imageBoy.onload = () => {
        ctx.drawImage(imageBoy, charaX, charaX, charaW, charaH);
      };
      imageItem.onload = () => {
        kinokoGroup.forEach(kinoko => {
          kinoko.draw()
        })
      }
      // キー入力イベント
      window.onkeydown = (event) => {
        switch (event.code) {
          case "ArrowUp":
            charaY -= 10;
            break;
          case "ArrowDown":
            charaY += 10;
            break;
          case "ArrowRight":
            charaX += 10;
            break;
          case "ArrowLeft":
            charaX -= 10;
            break;
          default:
        }
        charaMove();
      };
    </script>
  </body>
</html>
